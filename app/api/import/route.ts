import { NextRequest } from "next/server";
import { requireAuth } from "@/lib/auth";
import { prisma } from "@/lib/db";
import { successResponse, errorResponse, serverErrorResponse } from "@/lib/api-response";
import { WeChatTransaction } from "@/lib/import/wechat";

// 微信账单自动分类映射
const categoryKeywordMap: Record<string, string[]> = {
  "餐饮": ["餐厅", "饭店", "餐馆", "食堂", "外卖", "小吃", "火锅", "烧烤", "快餐", "早餐", "午餐", "晚餐", "饮品", "咖啡", "奶茶", "酒吧", "麦当劳", "肯德基", "必胜客", "星巴克", "汉堡王", "德克士", "华莱士", "真功夫", "吉野家", "味千拉面", "永和大王", "海底捞", "呷哺呷哺", "小肥羊", "大龙燚", "小龙坎", "蜀大侠", "巴奴毛肚火锅", "谭鸭血", "贤和庄", "德庄", "刘一手", "皇城老妈", "小天鹅", "秦妈火锅", "桥头火锅", "孔亮火锅", "周师兄", "朱光玉", "陈艳红", "楠火锅", "袁老四", "火锅", "烧烤", "烤肉", "烤鱼", "烤串", "铁板烧", "烧腊", "卤味", "鸭脖", "鸭翅", "鸭掌", "鸭头", "鸡爪", "鸡翅", "鸡腿", "鸡排", "炸鸡", "烤鸭", "烧鸭", "白切鸡", "盐焗鸡", "黄焖鸡", "叫花鸡", "口水鸡", "烧鸡", "扒鸡", "熏鸡", "烤鸡", "炸鸡", "鸡公煲", "鸡煲", "煲仔饭", "盖浇饭", "炒饭", "炒面", "汤面", "拌面", "拉面", "刀削面", "炸酱面", "热干面", "担担面", "臊子面", "油泼面", "烩面", "板面", "米线", "米粉", "河粉", "肠粉", "凉皮", "凉粉", "凉面", "冷面", "酸辣粉", "螺蛳粉", "桂林米粉", "过桥米线", "土豆粉", "地瓜粉", "粉丝", "粉条", "面条", "面食", "包子", "馒头", "花卷", "烧卖", "饺子", "馄饨", "汤圆", "元宵", "粽子", "月饼", "蛋糕", "面包", "饼干", "巧克力", "糖果", "果冻", "布丁", "冰淇淋", "雪糕", "冰棒", "酸奶", "牛奶", "豆浆", "奶茶", "咖啡", "茶", "果汁", "汽水", "可乐", "雪碧", "芬达", "美年达", "七喜", "脉动", "红牛", "东鹏特饮", "营养快线", "旺仔牛奶", "AD钙奶", "爽歪歪", "娃哈哈", "农夫山泉", "怡宝", "百岁山", "康师傅", "统一", "冰露", "昆仑山", "依云", "巴黎水", "气泡水", "苏打水", "矿泉水", "纯净水", "蒸馏水", "自来水", "白开水", "茶水", "咖啡", "奶茶", "果汁", "汽水", "饮料", "酒水", "酒精", "白酒", "啤酒", "红酒", "黄酒", "米酒", "葡萄酒", "香槟", "鸡尾酒", "伏特加", "威士忌", "白兰地", "朗姆酒", "龙舌兰", "金酒", "利口酒", "力娇酒", "清酒", "烧酒", "梅酒", "果酒", "药酒", "保健酒", "黄酒", "白酒", "啤酒", "红酒", "酒", "餐饮", "吃", "喝", "食品", "披萨", "美团", "拉面", "饺子"],
  "交通": ["地铁", "公交", "出租车", "打车", "滴滴", "单车", "共享单车", "火车", "高铁", "飞机", "机票", "油费", "停车费", "过路费", "加油站", "高速", "路桥", "交通", "运输", "出行", "旅行", "旅游", "车票", "船票", "交通费", "通勤", "班车", "包车", "租车", "自驾", "汽车", "车辆", "车", "地铁", "轨道交通", "城铁", "轻轨", "磁悬浮", "公交", "公共汽车", "巴士", "大巴", "中巴", "小巴", "出租车", "的士", "计程车", "网约车", "滴滴", "优步", "曹操出行", "首汽约车", "高德打车", "美团打车", "哈啰出行", "T3出行", "阳光出行", "滴滴顺风车", "拼车", "共享单车", "共享自行车", "共享电动车", "ofo", "摩拜", "哈啰单车", "青桔单车", "美团单车", "滴滴单车", "小蓝单车", "优拜单车", "永安行", "公共自行车", "自行车", "电动车", "摩托车", "三轮车", "四轮车", "汽车", "轿车", "SUV", "MPV", "跑车", "豪华车", "越野车", "卡车", "货车", "客车", "公交车", "出租车", "网约车", "班车", "包车", "租车", "自驾车", "私家车", "二手车", "新车", "汽车销售", "汽车维修", "汽车保养", "汽车美容", "洗车", "加油", "加油站", "中石化", "中石油", "中海油", "壳牌", "BP", "埃克森美孚", "道达尔", "雪佛龙", "马拉松石油", "康菲石油", "加油站", "油费", "汽油", "柴油", "煤油", "机油", "润滑油", "停车", "停车场", "停车费", "车位", "停车位", "停车库", "高速", "高速公路", "过路费", "过桥费", "过隧道费", "收费站", "ETC", "高速费", "路桥费", "交通罚款", "违章", "罚单", "扣分", "驾驶证", "行驶证", "车辆年检", "年审", "保险", "车险", "交强险", "商业险", "第三者责任险", "车损险", "盗抢险", "玻璃险", "划痕险", "自燃险", "涉水险", "不计免赔", "火车", "高铁", "动车", "城际铁路", "普速列车", "绿皮车", "硬座", "硬卧", "软卧", "软座", "一等座", "二等座", "商务座", "无座", "站票", "火车票", "高铁票", "动车票", "列车", "车次", "车站", "火车站", "高铁站", "动车站", "机场", "飞机场", "航空", "航班", "机票", "登机牌", "行李", "托运", "安检", "登机", "起飞", "降落", "延误", "取消", "改签", "退票", "航空公司", "国航", "东航", "南航", "海航", "厦航", "上航", "深航", "山航", "川航", "春秋航空", "吉祥航空", "奥凯航空", "华夏航空", "西部航空", "北部湾航空", "成都航空", "多彩贵州航空", "福州航空", "桂林航空", "海南航空", "河北航空", "江西航空", "昆明航空", "兰州航空", "山东航空", "深圳航空", "四川航空", "天津航空", "乌鲁木齐航空", "西藏航空", "祥鹏航空", "浙江长龙航空", "中国国际航空", "中国东方航空", "中国南方航空", "中国海南航空", "船", "轮船", "客轮", "货轮", "游轮", "邮轮", "轮渡", "摆渡船", "快艇", "游艇", "帆船", "渔船", "货船", "客船", "码头", "港口", "船票", "轮渡票", "交通", "运输"],
  "购物": ["超市", "商场", "商店", "便利店", "淘宝", "京东", "拼多多", "网购", "电商", "服装", "鞋子", "化妆品", "电子产品", "数码", "电器", "家具", "家居", "饰品", "首饰", "珠宝", "手表", "眼镜", "箱包", "皮具", "运动", "健身", "户外", "图书", "文具", "玩具", "礼品", "礼物", "鲜花", "蛋糕", "烘焙", "购物", "买", "购", "超市", "大卖场", "仓储超市", "会员店", "便利店", "社区店", "生鲜超市", "食品超市", "生活用品超市", "家居超市", "电器超市", "服装超市", "鞋帽超市", "箱包超市", "化妆品超市", "护肤品超市", "美妆超市", "彩妆超市", "香水超市", "珠宝超市", "首饰超市", "手表超市", "眼镜超市", "玩具超市", "文具超市", "图书超市", "音像超市", "礼品超市", "鲜花超市", "蛋糕超市", "烘焙超市", "运动用品超市", "健身用品超市", "户外用品超市", "汽车用品超市", "办公用品超市", "文具用品超市", "电脑用品超市", "数码用品超市", "手机用品超市", "家电超市", "电器超市", "家具超市", "家居超市", "家纺超市", "厨具超市", "餐具超市", "五金超市", "工具超市", "建材超市", "装饰材料超市", "灯具超市", "开关插座超市", "电线电缆超市", "管材管件超市", "油漆涂料超市", "瓷砖超市", "地板超市", "卫浴超市", "洁具超市", "水龙头超市", "马桶超市", "浴缸超市", "淋浴房超市", "浴室柜超市", "五金配件超市", "螺丝螺母超市", "钉子超市", "胶水超市", "胶带超市", "工具超市", "手动工具超市", "电动工具超市", "气动工具超市", "测量工具超市", "仪器仪表超市", "机械配件超市", "轴承超市", "齿轮超市", "链条超市", "链轮超市", "皮带超市", "输送带超市", "密封件超市", "紧固件超市", "标准件超市", "非标准件超市", "模具超市", "模具配件超市", "刀具超市", "刃具超市", "量具超市", "夹具超市", "辅具超市", "机床附件超市", "机器人配件超市", "自动化配件超市", "电子元件超市", "集成电路超市", "芯片超市", "电阻超市", "电容超市", "电感超市", "二极管超市", "三极管超市", "场效应管超市", "晶闸管超市", "继电器超市", "开关超市", "插座超市", "插头超市", "电线超市", "电缆超市", "光纤超市", "光缆超市", "连接器超市", "接插件超市", "端子超市", "端子排超市", "接线端子超市", "电缆接头超市", "电缆终端头超市", "母线槽超市", "桥架超市", "配电柜超市", "配电箱超市", "控制柜超市", "控制箱超市", "电源超市", "变压器超市", "稳压器超市", "UPS超市", "电池超市", "蓄电池超市", "锂电池超市", "干电池超市", "太阳能电池超市", "充电器超市", "充电设备超市", "逆变器超市", "变频器超市", "软启动器超市", "接触器超市", "断路器超市", "熔断器超市", "热继电器超市", "按钮超市", "指示灯超市", "蜂鸣器超市", "传感器超市", "接近开关超市", "光电开关超市", "行程开关超市", "压力开关超市", "温度开关超市", "流量开关超市", "液位开关超市", "编码器超市", "光栅尺超市", "数显表超市", "温控器超市", "变频器超市", "PLC超市", "DCS超市", "工控机超市", "人机界面超市", "触摸屏超市", "组态软件超市", "工业软件超市", "办公软件超市", "软件超市", "系统软件超市", "应用软件超市", "游戏软件超市", "教育软件超市", "杀毒软件超市", "安全软件超市", "工具软件超市", "办公设备超市", "电脑超市", "笔记本电脑超市", "台式电脑超市", "平板电脑超市", "一体机电脑超市", "迷你电脑超市", "服务器超市", "工作站超市", "电脑配件超市", "CPU超市", "处理器超市", "主板超市", "内存超市", "内存条超市", "硬盘超市", "机械硬盘超市", "固态硬盘超市", "混合硬盘超市", "显卡超市", "独立显卡超市", "集成显卡超市", "声卡超市", "独立声卡超市", "集成声卡超市", "网卡超市", "独立网卡超市", "集成网卡超市", "电源超市", "电脑电源超市", "机箱电源超市", "机箱超市", "电脑机箱超市", "台式机箱超市", "HTPC机箱超市", "服务器机箱超市", "散热器超市", "CPU散热器超市", "显卡散热器超市", "机箱散热器超市", "水冷散热器超市", "风冷散热器超市", "风扇超市", "CPU风扇超市", "机箱风扇超市", "电源风扇超市", "电脑周边超市", "鼠标超市", "有线鼠标超市", "无线鼠标超市", "蓝牙鼠标超市", "游戏鼠标超市", "办公鼠标超市", "光电鼠标超市", "激光鼠标超市", "触控鼠标超市", "轨迹球鼠标超市", "键盘超市", "有线键盘超市", "无线键盘超市", "蓝牙键盘超市", "游戏键盘超市", "办公键盘超市", "机械键盘超市", "薄膜键盘超市", "静电容键盘超市", "触控键盘超市", "键盘鼠标套装超市", "鼠标垫超市", "键盘垫超市", "电脑椅超市", "办公椅超市", "游戏椅超市", "人体工学椅超市", "显示器超市", "电脑显示器超市", "液晶显示器超市", "LED显示器超市", "OLED显示器超市", "曲面显示器超市", "平面显示器超市", "2K显示器超市", "4K显示器超市", "8K显示器超市", "电竞显示器超市", "办公显示器超市", "设计显示器超市", "绘图显示器超市", "专业显示器超市", "家用显示器超市", "商用显示器超市", "显示器支架超市", "电视超市", "彩电超市", "液晶电视超市", "LED电视超市", "OLED电视超市", "曲面电视超市", "平面电视超市", "2K电视超市", "4K电视超市", "8K电视超市", "智能电视超市", "网络电视超市", "高清电视超市", "超高清电视超市", "4K超高清电视超市", "8K超高清电视超市", "大屏电视超市", "小屏电视超市", "家用电视超市", "商用电视超市", "电视挂架超市", "音响超市", "电视音响超市", "家庭影院音响超市", "蓝牙音响超市", "便携音响超市", "桌面音响超市", "落地音响超市", "书架音响超市", "环绕音响超市", "回音壁音响超市", "低音炮超市", "电器超市", "大家电超市", "小家电超市", "白色家电超市", "黑色家电超市", "厨房电器超市", "卫浴电器超市", "生活电器超市", "办公电器超市", "数码电器超市", "家电超市", "大家电超市", "彩电超市", "冰箱超市", "洗衣机超市", "空调超市", "热水器超市", "燃气灶超市", "油烟机超市", "消毒柜超市", "洗碗机超市", "烤箱超市", "微波炉超市", "电饭煲超市", "压力锅超市", "豆浆机超市", "榨汁机超市", "搅拌机超市", "破壁机超市", "面包机超市", "咖啡机超市", "电水壶超市", "电热水壶超市", "电暖壶超市", "电饼铛超市", "电煎锅超市", "电火锅超市", "电炖锅超市", "电蒸锅超市", "电烤箱超市", "空气炸锅超市", "电炸锅超市", "电烤炉超市", "电陶炉超市", "电磁炉超市", "电炉超市", "电暖器超市", "电热油汀超市", "暖风机超市", "电暖扇超市", "电热毯超市", "电热水袋超市", "暖手宝超市", "加湿器超市", "除湿机超市", "空气净化器超市", "净水器超市", "饮水机超市", "直饮机超市", "软水机超市", "管线机超市", "厨下净水器超市", "台式净水器超市", "前置过滤器超市", "后置过滤器超市", "中央净水器超市", "中央软水器超市", "垃圾处理器超市", "食物垃圾处理器超市", "厨房垃圾处理器超市", "卫浴电器超市", "电热水器超市", "燃气热水器超市", "太阳能热水器超市", "空气能热水器超市", "浴霸超市", "排气扇超市", "换气扇超市", "通风扇超市", "吹风机超市", "电吹风超市", "电熨斗超市", "挂烫机超市", "蒸汽熨斗超市", "吸尘器超市", "卧式吸尘器超市", "立式吸尘器超市", "手持吸尘器超市", "无线吸尘器超市", "有线吸尘器超市", "机器人吸尘器超市", "扫地机器人超市", "拖地机器人超市", "洗地机超市", "擦窗机器人超市", "空气净化器超市", "加湿器超市", "除湿机超市", "电风扇超市", "落地扇超市", "台式扇超市", "壁挂扇超市", "吊扇超市", "塔扇超市", "无叶扇超市", "空调扇超市", "冷风扇超市", "暖风扇超市", "生活电器超市", "电动牙刷超市", "冲牙器超市", "洗牙器超市", "电子秤超市", "体重秤超市", "体脂秤超市", "厨房秤超市", "台秤超市", "落地秤超市", "血压计超市", "电子血压计超市", "水银血压计超市", "血糖仪超市", "电子血糖仪超市", "体温计超市", "电子体温计超市", "水银体温计超市", "耳温枪超市", "额温枪超市", "室内温度计超市", "室外温度计超市", "湿度计超市", "温湿度计超市", "计时器超市", "闹钟超市", "电子钟超市", "挂钟超市", "台钟超市", "座钟超市", "手表超市", "智能手表超市", "运动手表超市", "户外手表超市", "潜水手表超市", "航空手表超市", "赛车手表超市", "奢侈手表超市", "名牌手表超市", "瑞士手表超市", "日本手表超市", "国产手表超市", "灯具超市", "吊灯超市", "吸顶灯超市", "落地灯超市", "台灯超市", "壁灯超市", "床头灯超市", "厨房灯超市", "卫浴灯超市", "阳台灯超市", "走廊灯超市", "楼梯灯超市", "庭院灯超市", "路灯超市", "景观灯超市", "装饰灯超市", "节日灯超市", "LED灯超市", "节能灯超市", "荧光灯超市", "白炽灯超市", "卤素灯超市", "氙气灯超市", "浴霸灯超市", "紫外线灯超市", "红外线灯超市", "灭蚊灯超市", "杀虫灯超市", "应急灯超市", "手电筒超市", "强光手电超市", "普通手电超市", "头灯超市", "矿灯超市", "露营灯超市", "帐篷灯超市", "马灯超市", "煤油灯超市", "蜡烛超市", "火柴超市", "打火机超市", "烟具超市", "香烟超市", "卷烟超市", "雪茄超市", "烟斗超市", "烟丝超市", "烟叶超市", "烟具配件超市", "打火机超市", "火柴超市", "烟灰缸超市", "烟盒超市", "烟嘴超市", "过滤嘴超市", "文具超市", "办公用品超市", "学生文具超市", "儿童文具超市", "成人文具超市", "铅笔超市", "钢笔超市", "圆珠笔超市", "中性笔超市", "马克笔超市", "水彩笔超市", "蜡笔超市", "油画棒超市", "粉笔超市", "白板笔超市", "记号笔超市", "荧光笔超市", "彩色铅笔超市", "绘图铅笔超市", "考试铅笔超市", "自动铅笔超市", "铅笔芯超市", "笔芯超市", "中性笔芯超市", "圆珠笔芯超市", "钢笔墨囊超市", "钢笔墨水超市", "墨水超市", "墨汁超市", "砚台超市", "毛笔超市", "羊毫笔超市", "狼毫笔超市", "兼毫笔超市", "紫毫笔超市", "书画纸超市", "宣纸超市", "生宣超市", "熟宣超市", "半熟宣超市", "毛边纸超市", "元书纸超市", "高丽纸超市", "包装纸超市", "牛皮纸超市", "卡纸超市", "铜版纸超市", "打印纸超市", "复印纸超市", "白纸超市", "彩纸超市", "手工纸超市", "折纸超市", "剪纸超市", "贴纸超市", "不干胶超市", "标签纸超市", "便签纸超市", "便利贴超市", "N次贴超市", "便条纸超市", "笔记本超市", "记事本超市", "日记本超市", "练习本超市", "作业本超市", "错题本超市", "草稿本超市", "单词本超市", "字帖超市", "描红本超市", "画画本超市", "绘本超市", "图书超市", "书籍超市", "小说超市", "散文超市", "诗歌超市", "传记超市", "历史超市", "哲学超市", "宗教超市", "科学超市", "技术超市", "医学超市", "教育超市", "儿童读物超市", "少儿图书超市", "幼儿绘本超市", "婴儿读物超市", "青少年读物超市", "成人图书超市", "老年读物超市", "教材超市", "教科书超市", "教辅超市", "辅导书超市", "练习册超市", "试卷超市", "题库超市", "字典超市", "词典超市", "百科全书超市", "地图超市", "地球仪超市", "文具用品超市", "橡皮擦超市", "橡皮超市", "改正带超市", "修正带超市", "改正液超市", "修正液超市", "透明胶超市", "胶带超市", "双面胶超市", "固体胶超市", "胶水超市", "浆糊超市", "订书机超市", "订书钉超市", "回形针超市", "曲别针超市", "大头针超市", "图钉超市", "工字钉超市", "燕尾夹超市", "长尾夹超市", "票据夹超市", "文件夹超市", "资料夹超市", "档案夹超市", "文件袋超市", "资料袋超市", "档案袋超市", "公文包超市", "电脑包超市", "书包超市", "双肩包超市", "单肩包超市", "斜挎包超市", "手提包超市", "拉杆书包超市", "补习袋超市", "文具袋超市", "铅笔盒超市", "文具盒超市", "笔袋超市", "收纳盒超市", "整理盒超市", "储物盒超市", "工具箱超市", "工具包超市", "工具盒超市", "玩具超市", "儿童玩具超市", "婴儿玩具超市", "益智玩具超市", "启蒙玩具超市", "早教玩具超市", "积木超市", "乐高超市", "拼图超市", "拼插玩具超市", "模型超市", "汽车模型超市", "飞机模型超市", "船模型超市", "坦克模型超市", "机器人模型超市", "人偶模型超市", "手办超市", "动漫周边超市", "游戏周边超市", "毛绒玩具超市", "布娃娃超市", "公仔超市", "玩偶超市", "电子玩具超市", "电动玩具超市", "遥控玩具超市", "机器人玩具超市", "无人机超市", "航模超市", "车模超市", "船模超市", "火车模型超市", "轨道玩具超市", "托马斯超市", "风火轮超市", "芭比娃娃超市", "迪士尼超市", "漫威超市", "DC超市", "变形金刚超市", "乐高超市", "美高超市", "培乐多超市", "橡皮泥超市", "彩泥超市", "水晶泥超市", "太空沙超市", "沙子玩具超市", "水玩具超市", "泳池玩具超市", "沙滩玩具超市", "水上乐园玩具超市", "球类玩具超市", "篮球玩具超市", "足球玩具超市", "排球玩具超市", "乒乓球玩具超市", "羽毛球玩具超市", "网球玩具超市", "棒球玩具超市", "垒球玩具超市", "橄榄球玩具超市", "手球玩具超市", "曲棍球玩具超市", "冰球玩具超市", "高尔夫球玩具超市", "台球玩具超市", "保龄球玩具超市", "乐器玩具超市", "电子琴玩具超市", "钢琴玩具超市", "吉他玩具超市", "小提琴玩具超市", "架子鼓玩具超市", "喇叭玩具超市", "哨子玩具超市", "口琴玩具超市", "竖琴玩具超市", "玩具超市", "礼品超市", "礼物超市", "鲜花超市", "蛋糕超市", "烘焙超市", "购物", "买", "购"],
  "教育": ["学校", "学费", "书本", "教材", "培训", "课程", "辅导班", "教育", "学习", "考试", "考证", "留学", "游学", "研学", "幼儿园", "小学", "中学", "大学", "研究生院", "博士", "硕士", "本科", "专科", "职业学校", "技校", "中专", "职高", "培训机构", "教育机构", "学习中心", "培训中心", "课程中心", "辅导中心", "补习班", "补课班", "兴趣班", "特长班", "艺术班", "音乐班", "美术班", "舞蹈班", "体育班", "奥数班", "英语班", "语文班", "数学班", "物理班", "化学班", "生物班", "历史班", "地理班", "政治班", "考试中心", "考点", "考场", "准考证", "成绩单", "毕业证", "学位证", "学历证", "资格证", "证书", "认证", "教育", "学习", "培训", "课程", "考试", "考证", "学校", "学院", "大学", "研究所", "研究院", "实验室", "图书馆", "书店", "书吧", "阅览室", "自习室", "教育", "学习", "培训", "课程", "考试", "考证", "学校", "学院", "大学", "研究所", "研究院", "实验室", "图书馆", "书店", "书吧", "阅览室", "自习室"],
  "娱乐": ["电影", "游戏", "娱乐", "KTV", "影院", "演出", "演唱会", "体育", "健身", "运动", "游泳", "瑜伽", "舞蹈", "音乐", "美术", "绘画", "书法", "摄影", "旅游", "旅行", "度假", "休闲", "娱乐", "游戏", "电竞", "网吧", "网咖", "桌游", "剧本杀", "密室逃脱", "轰趴", "派对", "聚会", "酒吧", "夜店", "迪厅", "舞厅", "歌厅", "影院", "电影院", "戏院", "剧院", "剧场", "音乐厅", "歌剧院", "话剧院", "儿童剧院", "演出", "表演", "演唱会", "音乐会", "话剧", "歌剧", "舞剧", "音乐剧", "儿童剧", "杂技", "魔术", "马戏", "体育", "运动", "健身", "健美", "瑜伽", "普拉提", "舞蹈", "街舞", "爵士舞", "拉丁舞", "芭蕾舞", "民族舞", "现代舞", "肚皮舞", "钢管舞", "武术", "跆拳道", "拳击", "散打", "泰拳", "柔道", "摔跤", "击剑", "射箭", "射击", "游泳", "跳水", "水球", "花样游泳", "田径", "马拉松", "短跑", "长跑", "中长跑", "跨栏", "跳远", "跳高", "三级跳远", "铅球", "铁饼", "标枪", "链球", "体操", "艺术体操", "竞技体操", "蹦床", "篮球", "足球", "排球", "乒乓球", "羽毛球", "网球", "棒球", "垒球", "橄榄球", "手球", "曲棍球", "冰球", "高尔夫球", "台球", "保龄球", "壁球", "板球", "马球", "藤球", "毽球", "门球", "沙狐球", "地掷球", "木球", "软式网球", "娱乐", "游戏", "玩", "乐"],
  "医疗": ["医院", "药店", "医疗", "药品", "看病", "治疗", "体检", "医生", "护士", "诊所", "卫生室", "社区医院", "卫生院", "保健院", "防疫站", "疾控中心", "急救中心", "血站", "献血", "输血", "制药", "药房", "药店", "药铺", "药材", "中药", "西药", "中成药", "草药", "处方药", "非处方药", "OTC", "保健品", "营养品", "补品", "医疗", "医院", "诊所", "药店", "医生", "护士", "看病", "治疗", "检查", "体检", "手术", "住院", "门诊", "急诊", "急救", "医疗", "医院", "诊所", "药店", "医生", "护士", "看病", "治疗", "检查", "体检", "手术", "住院", "门诊", "急诊", "急救"],
  "住房": ["房租", "水电费", "物业费", "宽带费", "燃气费", "水费", "电费", "煤气费", "暖气费", "物业费", "管理费", "维修费", "装修", "装饰", "家具", "家居", "家电", "电器", "房产", "房地产", "开发商", "中介", "租房", "买房", "卖房", "房贷", "首付", "按揭", "抵押", "公积金", "住房", "房子", "公寓", "别墅", "住宅", "小区", "花园", "广场", "大厦", "写字楼", "办公楼", "商铺", "店面", "门面", "出租", "租赁", "租金", "房租", "押金", "中介费", "服务费", "管理费", "物业费", "维修费", "保养费", "清洁费", "卫生费", "保安费", "停车费", "车位费", "水电费", "水费", "电费", "燃气费", "煤气费", "暖气费", "宽带费", "网费", "电话费", "话费", "有线电视费", "收视费", "物业费", "管理费", "维修费", "装修", "装饰", "家具", "家居", "家电", "电器", "住房", "房子", "公寓", "别墅", "住宅", "小区", "花园", "广场", "大厦", "写字楼", "办公楼", "商铺", "店面", "门面", "出租", "租赁", "租金", "房租", "押金", "中介费", "服务费", "管理费", "物业费", "维修费", "保养费", "清洁费", "卫生费", "保安费", "停车费", "车位费", "水电费", "水费", "电费", "燃气费", "煤气费", "暖气费", "宽带费", "网费", "电话费", "话费", "有线电视费", "收视费"],
  "生活缴费": ["水费", "电费", "燃气费", "煤气费", "暖气费", "宽带费", "网费", "电话费", "话费", "有线电视费", "收视费", "物业费", "管理费", "维修费", "保养费", "清洁费", "卫生费", "保安费", "停车费", "车位费", "缴费", "交费", "付款", "支付", "账单", "费用", "收费", "费用", "缴费", "交费", "付款", "支付", "账单", "费用", "收费", "费用"],
  "其他": ["其他", "杂项", "未分类", " Uncategorized"]
};

// 导入结果类型
interface ImportResult {
  success: boolean;
  message: string;
  imported: number;
  failed: number;
  errors?: string[];
}

export async function POST(request: NextRequest) {
  try {
    const userId = await requireAuth(request);
    
    // 获取请求体
    const body = await request.json();
    const { transactions }: { transactions: WeChatTransaction[] } = body;
    
    if (!transactions || !Array.isArray(transactions) || transactions.length === 0) {
      return errorResponse("没有需要导入的交易记录");
    }
    
    // 获取用户的分类列表，用于自动匹配
    const categories = await prisma.category.findMany({
      where: { userId },
      select: { id: true, name: true, type: true },
    });
    
    // 保存交易记录
    let imported = 0;
    let failed = 0;
    const errors: string[] = [];
    
    for (const transaction of transactions) {
      try {
        // 验证交易数据的有效性
        if (!transaction.merchant) {
          failed++;
          errors.push(`商户名称为空：${transaction.transactionTime.toLocaleString()}`);
          continue;
        }
        
        // 验证日期有效性
        const transactionDate = new Date(transaction.transactionTime);
        if (isNaN(transactionDate.getTime())) {
          failed++;
          errors.push(`日期格式错误：${transaction.merchant} (${transaction.transactionTime})`);
          continue;
        }
        
        // 验证金额有效性
        if (typeof transaction.amount !== 'number' || isNaN(transaction.amount)) {
          failed++;
          errors.push(`金额格式错误：${transaction.merchant} (${transaction.transactionTime.toLocaleString()})`);
          continue;
        }
        
        // 确定交易类型（收入、支出或中性）
        let type: "income" | "expense" | "neutral" = "expense";
        let amount = transaction.amount;
        
        // 处理收入情况（如转账收入、红包收入等）
        if (transaction.type.includes("收入") || 
            transaction.type.includes("收款") || 
            transaction.type.includes("转入") ||
            transaction.direction === "收入" ||
            transaction.direction === "收款" ||
            transaction.direction === "转入" ||
            amount < 0) {
          type = "income";
          amount = Math.abs(amount);
        } else if (transaction.direction === "/") {
          // 处理中性交易（微信账单中"/"表示中性）
          type = "neutral";
        } else if (transaction.direction === "\\") {
          // 处理收入交易（微信账单中"\\"表示收入）
          type = "income";
          amount = Math.abs(amount);
        }
        
        // 自动匹配分类 - 基于关键词映射
        let categoryId;
        try {
          categoryId = await findCategoryByKeywords(transaction.merchant, transaction.goods, type === 'neutral' ? 'expense' : type, categories, userId);
        } catch (catError) {
          console.error("分类匹配错误:", catError);
          // 分类匹配失败，使用默认分类
        }
        
        // 如果没有匹配到，使用默认分类
        if (!categoryId) {
          try {
            const defaultCategory = await getDefaultCategory(userId, type);
            categoryId = defaultCategory.id;
          } catch (defCatError) {
            console.error("获取默认分类错误:", defCatError);
            failed++;
            errors.push(`获取默认分类失败：${transaction.merchant} (${transactionDate.toLocaleString()})`);
            continue;
          }
        }
        
        // 构建描述信息，包含商户和商品信息
        // 格式：商户名称 - 商品信息（备注）
        const details = [];
        
        // 添加商户名称
        if (transaction.merchant) {
          details.push(transaction.merchant);
        }
        
        // 添加商品信息
        if (transaction.goods) {
          details.push(`- ${transaction.goods}`);
        }
        
        // 添加备注信息
        if (transaction.remark) {
          details.push(`（${transaction.remark}）`);
        }
        
        // 构建最终描述
        const description = details.join(' ');
        
        // 检查是否已存在相同的交易记录
        // 优先通过交易单号检查（如果有）
        let existingTransaction;
        
        if (transaction.transactionNo) {
          // 检查是否存在相同交易单号的交易记录
          existingTransaction = await prisma.transaction.findFirst({
            where: {
              userId,
              description: {
                contains: transaction.transactionNo
              }
            },
          });
        }
        
        // 如果没有ID或ID不存在，则通过其他字段组合检查
        if (!existingTransaction) {
          existingTransaction = await prisma.transaction.findFirst({
            where: {
              userId,
              // 通过其他字段组合检查，包括交易时间、金额和类型
              date: transactionDate,
              amount,
              type,
            },
          });
        }
        
        if (existingTransaction) {
          // 使用新导入的数据覆盖旧数据
          await prisma.transaction.update({
            where: {
              id: existingTransaction.id,
            },
            data: {
              type,
              amount,
              categoryId,
              description,
              date: transactionDate,
            },
          });
          // 更新成功，计入成功导入
          imported++;
          errors.push(`更新了已存在的交易记录：${transaction.merchant} (${transactionDate.toLocaleString()})`);
          continue;
        }
        
        // 创建新的交易记录
        await prisma.transaction.create({
          data: {
            userId,
            type,
            amount,
            categoryId,
            description,
            date: transactionDate,
          },
        });
        
        imported++;
      } catch (error) {
        console.error("保存交易记录错误:", error);
        failed++;
        errors.push(`保存失败：${transaction.merchant} (${transaction.transactionTime.toLocaleString()}) - ${error instanceof Error ? error.message : '未知错误'}`);
      }
    }
    
    const result: ImportResult = {
      success: imported > 0,
      message: `成功导入 ${imported} 条记录，失败 ${failed} 条记录`,
      imported,
      failed,
      errors: failed > 0 ? errors : undefined,
    };
    
    return successResponse(result, "导入完成");
  } catch (error) {
    console.error("导入API错误:", error);
    
    if (error instanceof Error && error.message === "未授权") {
      return errorResponse("未授权", 401);
    }
    
    return serverErrorResponse(error, "导入失败");
  }
}

// 分类缓存，避免重复创建分类，按用户ID隔离
const categoriesCache: Map<string, Map<string, string>> = new Map();

// 根据关键词查找分类
async function findCategoryByKeywords(merchant: string, goods: string | undefined, type: "income" | "expense", categories: Array<{ id: string; name: string; type: "income" | "expense" }>, userId: string): Promise<string | undefined> {
  // 首先尝试精确匹配用户已有的分类
  let categoryId = categories.find(c => 
    c.type === type && 
    (merchant.includes(c.name) || (goods && goods.includes(c.name)))
  )?.id;
  
  if (categoryId) {
    return categoryId;
  }
  
  // 存储匹配到的分类名称和关键词
  const matchedCategories: { categoryName: string; keyword: string; source: string }[] = [];
  
  // 使用关键词映射查找匹配
  for (const [categoryName, keywords] of Object.entries(categoryKeywordMap)) {
    for (const keyword of keywords) {
      if (merchant.includes(keyword)) {
        matchedCategories.push({ categoryName, keyword, source: "merchant" });
      }
      if (goods && goods.includes(keyword)) {
        matchedCategories.push({ categoryName, keyword, source: "goods" });
      }
    }
  }
  
  // 优先选择更具体的关键词匹配
  // 1. 优先选择商品字段中的匹配
  // 2. 然后按关键词长度排序
  matchedCategories.sort((a, b) => {
    if (a.source === "goods" && b.source !== "goods") return -1;
    if (a.source !== "goods" && b.source === "goods") return 1;
    return b.keyword.length - a.keyword.length;
  });
  
  // 尝试为每个匹配的分类查找用户已有的分类
  for (const { categoryName } of matchedCategories) {
    // 生成缓存键
    const cacheKey = `${type}-${categoryName.toLowerCase()}`;
    
    // 确保用户的缓存映射存在
    if (!categoriesCache.has(userId)) {
      categoriesCache.set(userId, new Map());
    }
    
    const userCache = categoriesCache.get(userId)!;
    
    // 检查缓存
    if (userCache.has(cacheKey)) {
      return userCache.get(cacheKey);
    }
    
    // 先从传入的分类列表中查找
    let existingCategory = categories.find(c => 
      c.type === type && 
      (c.name === categoryName || 
       c.name.toLowerCase() === categoryName.toLowerCase() ||
       c.name.includes(categoryName) || 
       categoryName.includes(c.name))
    );
    
    // 如果传入的列表中没有，从数据库中查询
    if (!existingCategory) {
      existingCategory = await prisma.category.findFirst({
        where: {
          userId,
          type,
          name: categoryName
        }
      });
      
      // 也检查不区分大小写的匹配
      if (!existingCategory) {
        existingCategory = await prisma.category.findFirst({
          where: {
            userId,
            type,
            name: {
              equals: categoryName,
              mode: 'insensitive'
            }
          }
        });
      }
    }
    
    if (existingCategory) {
      // 更新缓存
      userCache.set(cacheKey, existingCategory.id);
      return existingCategory.id;
    } else {
      // 如果用户没有此分类，自动创建
      try {
        const newCategory = await prisma.category.create({
          data: {
            userId,
            name: categoryName,
            type,
            icon: getCategoryIcon(categoryName),
          },
        });
        // 将新创建的分类添加到categories列表中，避免后续交易重复创建
        categories.push(newCategory);
        // 更新缓存
        userCache.set(cacheKey, newCategory.id);
        return newCategory.id;
      } catch (error) {
        console.error(`创建分类失败: ${categoryName}`, error);
        // 创建失败，继续尝试下一个匹配
        continue;
      }
    }
  }
  
  // 如果没有匹配到，返回undefined
  return undefined;
}

// 获取分类图标
function getCategoryIcon(categoryName: string): string {
  const iconMap: Record<string, string> = {
    "餐饮": "🍽️",
    "交通": "🚗",
    "购物": "🛍️",
    "娱乐": "🎮",
    "医疗": "🏥",
    "教育": "📚",
    "住宿": "🏠",
    "通讯": "📱",
    "生活": "🧺",
    "旅游": "✈️",
    "运动": "🏃",
    "美容": "💄",
    "宠物": "🐱",
    "办公": "💼",
    "其他": "📦"
  };
  
  return iconMap[categoryName] || "📦";
}

// 获取默认分类
async function getDefaultCategory(userId: string, type: "income" | "expense" | "neutral") {
  // 确定默认分类名称
  let defaultName: string;
  switch (type) {
    case "income":
      defaultName = "其他收入";
      break;
    case "expense":
      defaultName = "其他支出";
      break;
    case "neutral":
      defaultName = "其他";
      break;
    default:
      defaultName = "其他";
  }
  
  // 查找是否已有默认分类
  let defaultCategory = await prisma.category.findFirst({
    where: {
      userId,
      type,
      name: defaultName,
    },
  });
  
  // 如果没有，创建默认分类
  if (!defaultCategory) {
    defaultCategory = await prisma.category.create({
      data: {
        userId,
        name: defaultName,
        type,
        icon: type === "income" ? "💰" : type === "expense" ? "💸" : "📦",
      },
    });
  }
  
  return defaultCategory;
}